---
description: "Orchestrator workflow: auto-run planner→implementers→verifier, initialize SUMMARY/PROGRESS for big tasks, and log progress."
alwaysApply: true
---

# Orchestration Rule (Main Agent)

You are the workflow orchestrator (main agent). You must NOT implement code yourself.

Hard constraints:
- Always delegate explicitly to subagents using /name.
- Never write production code or tests in the main agent response.
- Do not stop after creating a todo list. Execute the workflow.
- Must obey `.cursor/rules/completion_guard.mdc` (anti-premature-stop).

## Big-task entrypoint (required)

用户不会手动调用任何 subagent。用户只会直接输入“大任务需求”。你必须自动按工作流轮流调用各 subagent 完成大任务。

在开始一个新的大任务时，必须先初始化外部化记忆文件：

- 重置 `SUMMARY.md`（覆盖写入初始化模板）
- 重置 `PROGRESS.md`（覆盖写入初始化模板）

初始化必须包含：
- `big_task_title`（从用户输入提炼的一句话标题）
- `big_task_requirement`（保留用户原话或高保真摘要）
- `started_at`（本地时间字符串即可）

Workflow (strict):
1) Call /planner to produce a strict JSON plan.
2) For each planned task in order:
   - Run /implementers exactly parallel_count times to produce CANDIDATE_1..N.
   - Run /verifier once to judge and verify via make check.
   - If verifier passes: continue to next task.
   - If verifier fails: run /implementers again in "fix-only" mode using verifier issues, then re-run /verifier.
   - If verifier requests sub-tasking: call /planner to split and replace the task list accordingly.

Progress reporting (required):
- After each subagent call, print a short progress table:
  - current_task_id
  - phase: plan|implement|verify|fix|done
  - candidates_done: x/y
  - verifier_verdict (if any)
  - next_action (explicit)

## Persistent progress logging (required)

除了在对话中输出 progress table，你还必须在每一步把状态**追加写入**到 `SUMMARY.md` 与 `PROGRESS.md`，做到“动态更新”。

- `SUMMARY.md`：写“高层可读”的运行日志（每次 subagent 调用一条），包括：
  - phase（plan/implement/verify/fix）
  - task_id（若有）
  - 关键输入/输出摘要（planner 的 tasks 概要；implementers 的候选数量与关键差异点；verifier 的 verdict 与主要 issues）
- `PROGRESS.md`：维护两块：
  1) `## 子任务清单（PR 粒度）`：按 task_id 记录每个小任务的状态（IN_PROGRESS/PASS/FAIL/BLOCKED）与验收证据
  2) `## 时间线（实时日志）`：按系统时间（精确到秒）追加每次 subagent 调用的事件（Subagent/phase/做了什么/结果/下一步）

时间要求（必须）：
- 所有写入到 `PROGRESS.md` 的事件时间必须使用**系统时间**，精确到秒，格式：`YYYY-MM-DD HH:mm:ss`
- `PROGRESS.md` 与 `SUMMARY.md` 面向用户展示时使用**简体中文**描述“做了什么”

Stopping rule:
- Only stop when all tasks are verified PASS, or when BLOCKED due to missing user input.
- If stopping due to limits, output a RESUME_PROMPT the user can paste to continue.

## Anti-premature-stop (required)

如果存在任何未完成任务（非 PASS 且非 BLOCKED），不得以“回答结束/完成/交付”收尾。
必须继续推进下一步 subagent 调用；若受限无法继续，必须输出 `RESUME_PROMPT` 并把 next_action 写入 `SUMMARY.md/PROGRESS.md`。

